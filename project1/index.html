<!doctype html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="Generator" content="EditPlus®">
	<meta name="Author" content="">
	<meta name="Keywords" content="">
	<meta name="Description" content="">
	<title>OS project1 - realtime scheduling</title>
	<link rel="stylesheet" href="./css/bootstrap.min.css">
	<script src="./js/jquery.min.js"></script>
	<script src="./js/bootstrap.min.js"></script>
	<style>
.top-intro { margin-top:30px; margin-bottom:0; }
.task-list-box { margin-top:30px; }
.task-list-box .random-group { margin-bottom:0; }
.task-list-box .task-list { height:100px !important; }
.controller { padding:20px; text-align:center; }
.controller .server { width:200px; display:inline-block; }
.result table { table-layout:fixed }
.result table td { text-align:center; }
	</style>
</head>
<body>
	<div class="container">
		<div class="jumbotron top-intro">
			<h2>OS Project1 - Realtime Scheduling</h2>
			<p>
				2017104005 컴퓨터공학과 오윤석<br>
				랜덤 또는 Task를 입력해 실행해주세요.
			</p>
		</div>

		<div class="row">
			<div class="col-md-6 task-list-box">
				<h4>주기적 Task</h4>
				<div class="form-group random-group">
					<input type="checkbox" id="is-periodic-random">
					<label id="is-periodic-random">랜덤 적용</label>
				</div>
				<textarea id="periodic-list" class="form-control task-list">10 2
15 3
30 4</textarea>
				<p>
					<strong>주기 계산시간 \n 주기 계산시간</strong> 형태로 입력해주세요.<br>
					이름은 주기로 정렬된 후 순서대로 P0 ~ Pn으로 부여됩니다.
				</p>
			</div>
			<div class="col-md-6 task-list-box">
				<h4>비주기적 Task</h4>
				<div class="form-group random-group">
					<input type="checkbox" id="is-aperiodic-random">
					<label id="is-aperiodic-random">랜덤 적용</label>
				</div>
				<textarea id="aperiodic-list" class="form-control task-list">5 1
12 1
15 2</textarea>
				<p>
					<strong>도착시각 계산시간 \n 도착시각 계산시간</strong> 형태로 입력해주세요.<br>
					이름은 도착시간으로 정렬된 후 순서대로 AP0 ~ APn으로 부여됩니다.
				</p>
			</div>
		</div>

		<div class="controller">
			<div class="row">
				<div class="col-md-6 form-group text-right">
					<label for="server">Server 주기</label><br>
					<input type="number" class="form-control server" id="server-t" value="5">
				</div>
				<div class="col-md-6 form-group text-left">
					<label for="server">Server 계산시간</label><br>
					<input type="number" class="form-control server" id="server-c" value="1">
				</div>
			</div>
			<div class="buttons">
				<button class="btn btn-primary" id="btn-polling">Polling 계산</button>
				<button class="btn btn-success" id="btn-deferrable">Deferrable 계산</button>
			</div>
		</div>

		<div class="result">
			<h4>결과</h4>
			<table class="table table-bordered">
				<tbody>
					<tr class="process"></tr>
					<tr class="time"></tr>
				</tbody>
			</table>
			<p>
				비주기적 Task 평균 대기시간 : <span id="avg-aperiodic-waiting-time"></span>
			</p>
		</div>
	</div>

<script>
$(function() {
	function getInputs() {
		var periodicRandom = $("#is-periodic-random").is(":checked");
		var aperiodicRandom = $("#is-aperiodic-random").is(":checked");
		var periodic = new Array();
		var aperiodic = new Array();

		if(periodicRandom) {

		} else {
			var input = $("#periodic-list").val();
			var rows = input.split("\n");
			for(i in rows) {
				var row = rows[i].trim().split(" ");

				if(row.length != 2)
					return null;

				periodic.push({
					t:parseInt(row[0]),
					c:parseInt(row[1])
				});
			}
		}

		if(aperiodicRandom) {

		} else {
			var input = $("#aperiodic-list").val();
			var rows = input.split("\n");
			for(i in rows) {
				var row = rows[i].trim().split(" ");

				if(row.length != 2)
					return null;

				aperiodic.push({
					a:parseInt(row[0]),
					c:parseInt(row[1])
				});
			}
		}

		var server = {
			t:parseInt($("#server-t").val()),
			c:parseInt($("#server-c").val())
		}

		return {
			periodic:periodic,
			aperiodic:aperiodic,
			server:server
		};
	}

	function isPossible(periodic, server) {
		if(server.t <= 0)
			return false;

		utilization = server.c / server.t;

		for(i in periodic) {
			if(periodic[i].t <= 0)
				return false;
			utilization += periodic[i].c / periodic[i].t;
		}
		
		maxUtilization = periodic.length * (Math.pow(2, 1/(periodic.length)) - 1)

		return utilization <= maxUtilization;
	}

	function lcm(input_array) {
		if (toString.call(input_array) !== "[object Array]")  
			return  false;  
		var r1 = 0, r2 = 0;
		var l = input_array.length;
		for(i=0;i<l;i++) {
			r1 = input_array[i] % input_array[i + 1];
			if(r1 === 0) {
				input_array[i + 1] = (input_array[i] * input_array[i+1]) / input_array[i + 1];
			} else {
				r2 = input_array[i + 1] % r1;
				if(r2 === 0) {
					input_array[i + 1] = (input_array[i] * input_array[i + 1]) / r1;
				} else {
					input_array[i+1] = (input_array[i] * input_array[i + 1]) / r2;
				}
			}
		}
		return input_array[l - 1];
	}

	function getHyperPeriod(periodic, server) {
		periods = new Array();
		periods.push(server.t);
		
		for(i in periodic) {
			periods.push(periodic[i].t);
		}

		return lcm(periods);
	}

	function sortPeriodic(periodic) {
		if(periodic.length < 2)
			return periodic;

		for(var i=1; i<periodic.length; i++) {
			for(var j=i; j<periodic.length; j++) {
				if(periodic[j-1].t > periodic[j].t) {
					var tmp = periodic[j-1];
					periodic[j-1] = periodic[j];
					periodic[j] = tmp;
				}
			}
		}

		return periodic
	}

	function sortAperiodic(aperiodic) {
		if(aperiodic.length < 2)
			return aperiodic;

		for(var i=1; i<aperiodic.length; i++) {
			for(var j=i; j<aperiodic.length; j++) {
				if(aperiodic[j-1].a > aperiodic[j].a) {
					var tmp = aperiodic[j-1];
					aperiodic[j-1] = aperiodic[j];
					aperiodic[j] = tmp;
				}
			}
		}

		return aperiodic
	}

	function getPolling(inputs) {
		var hyperPeriod = getHyperPeriod(inputs.periodic, inputs.server);
		var periodic = sortPeriodic(inputs.periodic);
		var aperiodic = sortAperiodic(inputs.aperiodic);
		var usingTask = -1;
		var avgAperiodicWaitingTime = 0;
		var serverRemain = 0;
		var tasks = new Array();

		for(i in aperiodic) {
			aperiodic[i].remain = aperiodic[i].c;
		}

		for(t=0; t<hyperPeriod; t++) {
			for(i in periodic) {
				if(t % periodic[i].t == 0) {
					periodic[i].remain = periodic[i].c;
				}
			}

			if(t % inputs.server.t == 0) {
				usingTask = -2;	// AP
				serverRemain = inputs.server.c;
			}
			
			if(usingTask == -2) {
				var continueTask = false;
				for(j in aperiodic) {
					if(t >= aperiodic[j].a && aperiodic[j].remain > 0) {
						if(--aperiodic[j].remain == 0)
							aperiodic[j].finished = t + 1;
						tasks.push('AP' + j);
						continueTask = true;
						break;
					}
				}
				if(--serverRemain == 0)
					usingTask = -1;
				if(continueTask)
					continue;
			}
			
			for(i in periodic) {
				if(periodic[i].remain > 0) {
					usingTask = parseInt(i)
					break;
				}
			}

			if(usingTask != -1) {
				tasks.push('P' + usingTask);
				if(--periodic[usingTask].remain == 0)
					usingTask = -1;
			} else {
				tasks.push('');
			}
		}

		for(i in aperiodic) {
			if(aperiodic[i].finished == undefined) {
				avgAperiodicWaitingTime = '모든 비주기적 Task가 완료되지 않음';
				break;
			} else {
				avgAperiodicWaitingTime += aperiodic[i].finished - aperiodic[i].a - aperiodic[i].c;
			}
		}
		
		if(!isNaN(avgAperiodicWaitingTime))
			avgAperiodicWaitingTime /= aperiodic.length;

		return {
			tasks:tasks,
			avgAperiodicWaitingTime:avgAperiodicWaitingTime
		};
	}

	function getDeferrable(inputs) {
		var hyperPeriod = getHyperPeriod(inputs.periodic, inputs.server);
		var periodic = sortPeriodic(inputs.periodic);
		var aperiodic = sortAperiodic(inputs.aperiodic);
		var usingTask = -1;
		var avgAperiodicWaitingTime = 0;
		var serverRemain = 0;
		var tasks = new Array();

		for(i in aperiodic) {
			aperiodic[i].remain = aperiodic[i].c;
		}

		for(t=0; t<hyperPeriod; t++) {
			for(i in periodic) {
				if(t % periodic[i].t == 0) {
					periodic[i].remain = periodic[i].c;
				}
			}

			if(t % inputs.server.t == 0) {
				serverRemain = inputs.server.c;
			}
			
			if(serverRemain > 0) {
				var continueTask = false;
				for(j in aperiodic) {
					if(t >= aperiodic[j].a && aperiodic[j].remain > 0) {
						if(--aperiodic[j].remain == 0)
							aperiodic[j].finished = t + 1;
						tasks.push('AP' + j);
						continueTask = true;
						serverRemain--;
						break;
					}
				}
				if(continueTask)
					continue;
			}
			
			for(i in periodic) {
				if(periodic[i].remain > 0) {
					usingTask = parseInt(i)
					break;
				}
			}

			if(usingTask != -1) {
				tasks.push('P' + usingTask);
				if(--periodic[usingTask].remain == 0)
					usingTask = -1;
			} else {
				tasks.push('');
			}
		}

		for(i in aperiodic) {
			if(aperiodic[i].finished == undefined) {
				avgAperiodicWaitingTime = '모든 비주기적 Task가 완료되지 않음';
				break;
			} else {
				avgAperiodicWaitingTime += aperiodic[i].finished - aperiodic[i].a - aperiodic[i].c;
			}
		}
		
		if(!isNaN(avgAperiodicWaitingTime))
			avgAperiodicWaitingTime /= aperiodic.length;

		return {
			tasks:tasks,
			avgAperiodicWaitingTime:avgAperiodicWaitingTime
		};
	}

	function showTable(tasks) {
		$("table .process td").remove();
		$("table .time td").remove();

		var colspanTasks = new Array();
		var remainTask = '';
		var remainTaskSize = 0;

		for(i in tasks) {
			if(tasks[i] == remainTask)
				remainTaskSize++;
			else {
				if(i != 0) {
					colspanTasks.push({
						task:remainTask,
						colspan:remainTaskSize
					});
				}
				remainTask = tasks[i];
				remainTaskSize = 1;
			}
			$("table .time").append("<td>" + i + "</td>");
		}

		colspanTasks.push({
			task:remainTask,
			colspan:remainTaskSize
		});

		for(i in colspanTasks) {
			$("table .process").append("<td colspan='" + colspanTasks[i].colspan + "'>" + colspanTasks[i].task + "</td>");
		}
	}

	function showAvgAperiodicWaitingTime(avgAperiodicWaitingTime) {
		$("#avg-aperiodic-waiting-time").text(avgAperiodicWaitingTime);
	}

	$("#btn-polling").on("click", function() {
		inputs = getInputs();
		
		if(inputs === null) {
			alert("입력에 오류가 있습니다.");
			return;
		}
		
		if(isPossible(inputs.periodic, inputs.server)) {
			var result = getPolling(inputs);
			showTable(result.tasks);
			showAvgAperiodicWaitingTime(result.avgAperiodicWaitingTime);
		} else {
			alert("주기가 올바르지 않거나 마감시간 내에 종료할 수 없을 가능성이 있습니다.");
		}
	});

	$("#btn-deferrable").on("click", function() {
		inputs = getInputs();
		
		if(inputs === null) {
			alert("입력에 오류가 있습니다.");
			return;
		}
		
		if(isPossible(inputs.periodic, inputs.server)) {
			var result = getDeferrable(inputs);
			showTable(result.tasks);
			showAvgAperiodicWaitingTime(result.avgAperiodicWaitingTime);
		} else {
			alert("주기가 올바르지 않거나 마감시간 내에 종료할 수 없을 가능성이 있습니다.");
		}
	});
});
</script>
</body>
</html>
